<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content=""><meta name="keyword" content="hodo zphua zp"><link rel="shortcut icon" href="/old-blog/img/ironman-draw.png"><script async defer src="https://buttons.github.io/buttons.js"></script><title>jQuery-整体架构 - zp</title><link rel="canonical" href="http://www.pinghuazhuang.com/2017/03/06/jQuery-code/jQuery-整体架构/"><link rel="stylesheet" href="/old-blog/css/bootstrap.min.css"><link rel="stylesheet" href="/old-blog/css/beantech.min.css"><link rel="stylesheet" href="/old-blog/css/highlight.css"><link rel="stylesheet" href="/old-blog/css/widget.css"><link rel="stylesheet" href="/old-blog/css/rocket.css"><link rel="stylesheet" href="/old-blog/css/signature.css"><link rel="stylesheet" href="/old-blog/css/toc.css"><link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"><!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]--><script></script></head><body ontouchstart=""><style type="text/css">header.intro-header{background-image:url(/img/header-bg.png)}#signature{background-image:url(/img/signature/BeanTechSign-white.png)}</style><header class="intro-header"><div id="signature"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><div class="tags"><a class="tag" href="/old-blog/tags/#code" title="code">code</a> <a class="tag" href="/old-blog/tags/#jQuery" title="jQuery">jQuery</a></div><h1>jQuery-整体架构</h1><h2 class="subheading">jQuery 源码分析</h2><span class="meta">Posted by hodo on 2017-03-06</span></div></div></div></div></div></header><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/old-blog/">Hodo</a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/old-blog/">Home</a></li><li><a href="/old-blog/about/">About</a></li><li><a href="/old-blog/archive/">Archives</a></li><li><a href="/old-blog/tags/">Tags</a></li></ul></div></div></div></nav><script>function handleMagic(e){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic)</script><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-container"><blockquote><p><code>jQuery</code> 诞生这么多年, 源码分析的文章到处都是.</p><p>这里将以我个人理解对代码进行分析整理, 源码摘自<code>jQuery-2.1.4.js</code></p><p>附上我收录过写的最好的最笼统的分析贴 <a href="http://www.cnblogs.com/aaronjs/p/3278578.html" target="_blank" rel="external">jQuery源码分析</a></p></blockquote><h2 id="构建实例对象的方式"><a href="#构建实例对象的方式" class="headerlink" title="构建实例对象的方式"></a>构建实例对象的方式</h2><ul><li><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="$() 使用方式"></a><code>$()</code> 使用方式</h3><blockquote><p>jQuery 的核心就是操作 DOM 元素, 操作 DOM 元素就必须要先获取 DOM 对象</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$(<span class="string">"body"</span>).find(<span class="string">"h1"</span>).css(<span class="string">"fontSize"</span>, <span class="number">20</span>);</div><div class="line">$(<span class="string">"p"</span>).after(<span class="string">"div"</span>);</div></pre></td></tr></table></figure><p>从上面的代码中, 不难发现, $() 是一个工厂模式创建对象的函数, 最终返回的是 $ 的一个实例化对象, 为什么 $ 不使用 new 方式来创建对象呢? 因为方便!</p><p>简单的来分析一下:</p><ol><li>$ 使用了工厂模式来构建实例对象</li><li>通过返回的实例对象掉用原型方法来操作 DOM 元素</li></ol></li></ul><ul><li><h3 id="创建实例对象"><a href="#创建实例对象" class="headerlink" title="$() 创建实例对象"></a>$() 创建实例对象</h3><p>工厂模式:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 工厂模式创建对象</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ZP</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> obj = &#123;&#125;;</div><div class="line">  obj.name = name;</div><div class="line">  <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ZP.fn = ZP.prototype = &#123;</div><div class="line">  sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name + <span class="string">": helloWorld! "</span> + (str || <span class="string">''</span>));</div><div class="line">  &#125; </div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 实例化对象</span></div><div class="line"><span class="keyword">var</span> hodo = ZP(<span class="string">"zphua"</span>);		<span class="comment">// &#123; name: 'zphua' &#125;</span></div><div class="line"></div><div class="line"><span class="comment">// hodo.sayHello();  </span></div><div class="line"><span class="comment">// ==&gt; TypeError: hodo.sayHello is not a function</span></div></pre></td></tr></table></figure><p>​</p><p>返回的对象实例对象 <code>hodo</code> 拥有 <code>name</code> 属性, 值为 <code>&quot;zphua&quot;</code>.</p><p>但是很明显, 返回的 <code>obj</code> 对象是 <code>Object</code> 的实例对象, 不能调用 <code>ZP</code> 的 <code>sayHello</code> 实例方法</p><p>要使用 <code>sayHello</code> 实例方法, 就要让 <code>obj</code> 继承 <code>ZP</code> 的原型, 修改以上代码如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 工厂模式创建对象</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ZP</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">  <span class="keyword">var</span> obj = <span class="built_in">Object</span>.create(ZP.prototype);</div><div class="line">  obj.constructor = ZP;</div><div class="line">  obj.name = name;</div><div class="line">  <span class="keyword">return</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ZP.fn = ZP.prototype = &#123;</div><div class="line">  </div><div class="line">  <span class="comment">// 实例方法</span></div><div class="line">  sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name + <span class="string">": helloWorld! "</span> + (str || <span class="string">''</span>));</div><div class="line">  &#125; ,</div><div class="line"></div><div class="line">  <span class="comment">// 静态方法</span></div><div class="line">  toLaugh: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"哈哈哈哈哈!!~~~"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 实例化对象</span></div><div class="line"><span class="keyword">var</span> hodo = ZP(<span class="string">"zphua"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 调用实例方法</span></div><div class="line">hodo.sayHello(<span class="string">"toDay is Nice!"</span>);</div><div class="line"><span class="comment">// ==&gt; zphua: helloWorld! toDay is Nice!</span></div><div class="line"></div><div class="line"><span class="comment">// 调用静态方法</span></div><div class="line">hodo.toLaugh();</div><div class="line"><span class="comment">// ==&gt; 哈哈哈哈哈!!~~~</span></div></pre></td></tr></table></figure><p>​</p><p>到这里就可以成功的创建一个 <code>ZP</code> 的实例对象, 并且成功调用原型方法. 基本上, 再现了源码的效果, 来看看源码怎么写的吧.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Define a local copy of jQuery</span></div><div class="line">jQuery = <span class="function"><span class="keyword">function</span> (<span class="params">selector, context</span>) </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">// The jQuery object is actually just the init constructor 'enhanced'</span></div><div class="line">  <span class="comment">// Need init if jQuery is called (just allow error to be thrown if not included)</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> jQuery.fn.init(selector, context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">init = jQuery.fn.init = <span class="function"><span class="keyword">function</span> (<span class="params">selector, context</span>) </span>&#123;</div><div class="line">  <span class="comment">// body... (对参数进行一系列操做)</span></div><div class="line">  </div><div class="line">  <span class="comment">// makeArray: 创建 jQuery 对象数组的方法</span></div><div class="line">  <span class="keyword">return</span> jQuery.makeArray(selector, <span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Give the init function the jQuery prototype for later instantiation</span></div><div class="line">  init.prototype = jQuery.fn;</div></pre></td></tr></table></figure><p>​</p><p>这里很明显, 基本上实现方法是一样的, 但是看起来就是高端.</p><p>分析下进一步的实现思路:</p><ol><li>把 <code>obj</code> 的构造过程放在 <code>init</code> 方法里</li><li>改变 <code>this</code> 和 <code>prototype</code> <code>constructor</code> 指向</li></ol><p>进一步改进之前的代码吧</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 工厂模式创建对象</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ZP</span>(<span class="params">name</span>) </span>&#123;</div><div class="line">  <span class="comment">// body... 对 name 进行处理</span></div><div class="line"></div><div class="line">  <span class="comment">// 1. 用 init 构造函数创建对象</span></div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ZP.prototype.init(name);</div><div class="line">&#125;</div><div class="line"></div><div class="line">ZP.fn = ZP.prototype = &#123;</div><div class="line">  </div><div class="line">  <span class="comment">// 改变 constructor 指向</span></div><div class="line">  <span class="keyword">constructor</span>: ZP,</div><div class="line"></div><div class="line">  // 构造方法</div><div class="line">  init: function (name) &#123;</div><div class="line">    <span class="comment">// body... 对 name 进行处理</span></div><div class="line"></div><div class="line">    <span class="comment">// 添加属性</span></div><div class="line">    <span class="keyword">this</span>.name = name;</div><div class="line">  &#125;,</div><div class="line"></div><div class="line">  <span class="comment">// 实例方法</span></div><div class="line">  sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.name + <span class="string">": helloWorld! "</span> + (str || <span class="string">''</span>));</div><div class="line">  &#125; ,</div><div class="line"></div><div class="line">  <span class="comment">// 静态方法</span></div><div class="line">  toLaugh: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"哈哈哈哈哈!!~~~"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 2. 改变 this 指向, 继承原型方法, 同时修改了 constructor </span></div><div class="line">ZP.prototype.init.prototype = ZP.prototype;</div><div class="line"></div><div class="line"><span class="comment">// 实例化对象</span></div><div class="line"><span class="keyword">var</span> hodo = ZP(<span class="string">"zphua"</span>);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(hodo);</div><div class="line"></div><div class="line"><span class="comment">// 调用实例方法</span></div><div class="line">hodo.sayHello(<span class="string">"toDay is Nice!"</span>);</div><div class="line"><span class="comment">// ==&gt; zphua: helloWorld! toDay is Nice!</span></div><div class="line"></div><div class="line"><span class="comment">// 调用静态方法</span></div><div class="line">hodo.toLaugh();</div><div class="line"><span class="comment">// ==&gt; 哈哈哈哈哈!!~~~</span></div></pre></td></tr></table></figure><p>​</p></li><li><p>先看看结果吧</p><p><img src="/old-blog/hodo-01.png" alt="hodoResult"></p><p>到这里创建 <code>jquery</code> 实例对象就结束了.</p></li></ul><ul><li><p>调用实例方法和静态方法</p><ul><li><p>实例方法</p><blockquote><p>就是调用 <code>prototype</code> 上的方法, 例如: $().find(); $.each(); 等方法</p></blockquote></li><li><p>静态方法</p><blockquote><p>就是调用写在 jQuery 这个函数对象方法.</p><p>比如, 在 jQuery 中, $.each 方法就是提供给内部使用的遍历方法,$(“body”).each 方法就是实例方法. 调用者的不同, 方法实现的效果就不容. 最经典的比如 $.fn.extend = $.extend = function () {};</p><p>$.extend 将在之后的 blog 中分析</p></blockquote></li></ul></li></ul><h2 id="链式调用"><a href="#链式调用" class="headerlink" title="链式调用"></a>链式调用</h2><p>例如:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 结构体 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"demo"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 链式编程</span></div><div class="line">$(<span class="string">"body"</span>).find(<span class="string">"#demo"</span>).append($(<span class="string">"&lt;p&gt;"</span>, &#123;</div><div class="line">  id: <span class="string">"dp"</span></div><div class="line">&#125;)).css(<span class="string">"color"</span>, <span class="string">"red"</span>).html(<span class="string">"这是一个寂寞的天, 下着有些伤心的雨!"</span>);</div></pre></td></tr></table></figure><p>链式编程的实现原理很简单, 基本上遵循着一个规律:</p><blockquote><p>调用的时候1个参数是返回改属性值, 如果参数是2个, 那么返回自己, 关键就是 <code>return this</code></p></blockquote><p>实现思路如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ZP.fn.age = <span class="number">18</span>;</div><div class="line">ZP.fn.info = <span class="function"><span class="keyword">function</span> (<span class="params">key, val</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (val) &#123;</div><div class="line">    <span class="keyword">this</span>[key] = val</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>[key];</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'hodo.info("age"): '</span>, hodo.info(<span class="string">"age"</span>));</div><div class="line"><span class="comment">// ==&gt; hodo.info("age"):  18</span></div><div class="line"><span class="built_in">console</span>.log(<span class="string">'hodo.info("name", "sb"): '</span>, hodo.info(<span class="string">"name"</span>, <span class="string">"jack"</span>));</div><div class="line"><span class="comment">// ==&gt; hodo.info("name", "sb"):  hodo</span></div></pre></td></tr></table></figure><p>附上结果图</p><p><img src="/old-blog/hodo-02.png" alt="hodo-02"></p><h2 id="插件接口-extend"><a href="#插件接口-extend" class="headerlink" title="插件接口(extend)"></a>插件接口(extend)</h2><blockquote><p>jQuery 向外界提过了扩展方法是 API: extend 方法.</p></blockquote><ul><li><h3 id="扩展-方法"><a href="#扩展-方法" class="headerlink" title="扩展 方法"></a>扩展 方法</h3></li></ul><p>使用方法:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 扩展静态方法</span></div><div class="line">$.extend(&#123;</div><div class="line">  sayHello: <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(obj.name || obj + <span class="string">": Hello!"</span>);</div><div class="line">  &#125;</div><div class="line">&#125;)</div><div class="line"></div><div class="line">$.sayHello(&#123; <span class="attr">name</span>: <span class="string">"obj"</span> &#125;);</div><div class="line"></div><div class="line"><span class="comment">// 扩展实例方法</span></div><div class="line">$.fn.extend(&#123;</div><div class="line">  getInnerHTML: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.html();</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><blockquote><p>这里有些地方是需要注意的, 在实例方法里面的 <code>this</code> 指向的是jQuery实例对象的, 调用的是jQuery原型方法</p></blockquote><p>源码是这么写的:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jQuery.extend = jQuery.fn.extend = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</div></pre></td></tr></table></figure><blockquote><p>jQuery和jQuery.fn的extend方法是同一个函数, 根据调用者的不同的添加方法的对象也就不同, 由于参数的数量的不同就会变成拷贝对象, 所以这里暂时讨论只有一个参数的情况.</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ZP.fn.extend = ZP.extend = <span class="function"><span class="keyword">function</span> (<span class="params">obj</span>) </span>&#123;</div><div class="line">  </div><div class="line">  <span class="comment">// 遍历对象拷贝对象(浅拷贝)</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> obj) &#123;</div><div class="line">    <span class="keyword">this</span>[key] = obj[key];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>这里, 有很多问题:</p><ol><li>obj 的属性也可能是一个对象, 上面的代码明显只能引用对象, 只是浅复制而已.</li><li>没有判断 key 是否为原型上的属性</li><li>不能拷贝不可便利的属性</li></ol><p>实际需求并没有那么的苛刻, 而jQuery源码也就只做了简单的深拷贝, 只解决的了第一个问题.</p><p>那么如何进行深复制呢? 很简单, 进行递归遍历, 创建对象再一个个属性的拷贝.</p><ul><li><h3 id="对象的深拷贝和浅拷贝"><a href="#对象的深拷贝和浅拷贝" class="headerlink" title="对象的深拷贝和浅拷贝"></a>对象的深拷贝和浅拷贝</h3></li></ul><p>前面讲到了 <code>extend</code> 方法单参数只有1个的时候是扩展方法, 那么当参数为一个以上的时候就变成了拷贝对象,.</p><p>根据需求的不同, 可以进行深拷贝和浅拷贝. 上面已经介绍了浅拷贝..</p><p>由于代码比较简单就直接上源代码, 附上详细的注释</p><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">jQuery.extend = jQuery.fn.extend = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> options,                        <span class="comment">// 要拷贝的对象</span></div><div class="line">        name,                           <span class="comment">// 遍历素材对象的键</span></div><div class="line">        src,                            <span class="comment">// 目标对象的键值</span></div><div class="line">        copy,                           <span class="comment">// 素材属性的键值</span></div><div class="line">        copyIsArray,                    <span class="comment">// 判断素材的键值是否为数组类型</span></div><div class="line">        clone,</div><div class="line">        				    		  <span class="comment">// 深复制使用的空对象或数组</span></div><div class="line">        <span class="comment">// 常见用法 jQuery.extend( obj1, obj2 )，此时，target为arguments[0]</span></div><div class="line">        target = <span class="built_in">arguments</span>[<span class="number">0</span>] || &#123;&#125;,	<span class="comment">// 最终返回的对象</span></div><div class="line">        i = <span class="number">1</span>,					      <span class="comment">// 表示当前的 arguments 的位置</span></div><div class="line">        length = <span class="built_in">arguments</span>.length,      <span class="comment">// arguments 的长度</span></div><div class="line">        deep = <span class="literal">false</span>;				   <span class="comment">// 判断是否深复制</span></div><div class="line"></div><div class="line">    <span class="comment">// Handle a deep copy situation</span></div><div class="line">    <span class="comment">// 如果第一个参数为true，即 jQuery.extend( true, obj1, obj2 ); 的情况</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target === <span class="string">"boolean"</span>) &#123;</div><div class="line">        deep = target;</div><div class="line"></div><div class="line">        <span class="comment">// Skip the boolean and the target</span></div><div class="line">        target = <span class="built_in">arguments</span>[i] || &#123;&#125;;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Handle case when target is a string or something (possible in deep copy)</span></div><div class="line">    <span class="comment">// 处理奇怪的情况，比如 jQuery.extend( 'hello' , &#123;nick: 'casper&#125;)~~</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target !== <span class="string">"object"</span> &amp;&amp; !jQuery.isFunction(target)) &#123;</div><div class="line">        target = &#123;&#125;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Extend jQuery itself if only one argument is passed</span></div><div class="line">    <span class="comment">// 处理 jQuery.extend(obj)，或 jQuery.fn.extend( obj ) 的情况</span></div><div class="line">    <span class="keyword">if</span> (i === length) &#123;</div><div class="line">        target = <span class="keyword">this</span>;</div><div class="line">        i--;            <span class="comment">// 减 1 是为了复制 arguments[0] 对象</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (; i &lt; length; i++) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Only deal with non-null/undefined values</span></div><div class="line">        <span class="comment">// 如果是深拷贝，且被拷贝的属性值本身是个对象</span></div><div class="line">        <span class="keyword">if</span> ((options = <span class="built_in">arguments</span>[i]) != <span class="literal">null</span>) &#123;</div><div class="line">            <span class="comment">// Extend the base object</span></div><div class="line">            <span class="keyword">for</span> (name <span class="keyword">in</span> options) &#123;</div><div class="line">                src = target[name];</div><div class="line">                copy = options[name];</div><div class="line"></div><div class="line">                <span class="comment">// Prevent never-ending loop</span></div><div class="line">                <span class="comment">// 防止自引用，不赘述</span></div><div class="line">                <span class="keyword">if</span> (target === copy) &#123;</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// Recurse if we're merging plain objects or arrays</span></div><div class="line">                <span class="keyword">if</span> (deep &amp;&amp; copy &amp;&amp; ( jQuery.isPlainObject(copy) || (copyIsArray = jQuery.isArray(copy)) )) &#123;</div><div class="line">                    <span class="keyword">if</span> (copyIsArray) &#123;  <span class="comment">// 被拷贝的属性值是个数组</span></div><div class="line">                        copyIsArray = <span class="literal">false</span>;</div><div class="line">                        clone = src &amp;&amp; jQuery.isArray(src) ? src : [];</div><div class="line"></div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        clone = src &amp;&amp; jQuery.isPlainObject(src) ? src : &#123;&#125;;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// Never move original objects, clone them</span></div><div class="line">                    <span class="comment">// 递归调用自己</span></div><div class="line">                    target[name] = jQuery.extend(deep, clone, copy);</div><div class="line"></div><div class="line">                    <span class="comment">// Don't bring in undefined values</span></div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (copy !== <span class="literal">undefined</span>) &#123;    <span class="comment">// 浅拷贝，且属性值不为undefined</span></div><div class="line">                    target[name] = copy;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Return the modified object</span></div><div class="line">  	<span class="comment">// 返回目标值</span></div><div class="line">    <span class="keyword">return</span> target;</div><div class="line">&#125;;</div></pre></td></tr></table></figure><hr><ul class="pager"><li class="previous"><a href="/old-blog/2017/04/20/ES6/es6中this的指向/" data-toggle="tooltip" data-placement="top" title="es6中this的指向">&larr; Previous Post</a></li><li class="next"><a href="/old-blog/2017/02/11/note/xxx-com/" data-toggle="tooltip" data-placement="top" title="xxx.com">Next Post &rarr;</a></li></ul><div class="comment"><div id="disqus_thread" class="disqus-thread"></div></div></div><aside id="sidebar"><div id="toc" class="toc-article"><strong class="toc-title">Contents</strong><ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#构建实例对象的方式"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">构建实例对象的方式</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用方式"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">$() 使用方式</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#创建实例对象"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">$() 创建实例对象</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#链式调用"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">链式调用</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#插件接口-extend"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">插件接口(extend)</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#扩展-方法"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">扩展 方法</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#对象的深拷贝和浅拷贝"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">对象的深拷贝和浅拷贝</span></a></li></ol></li></ol></div></aside><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 sidebar-container"><section><h5><a href="/old-blog/tags/">FEATURED TAGS</a></h5><div class="tags"><a class="tag" href="/old-blog/tags/#code" title="code">code</a> <a class="tag" href="/old-blog/tags/#jQuery" title="jQuery">jQuery</a></div></section><hr><h5>FRIENDS</h5><ul class="list-inline"></ul></div></div></div></article><script type="text/javascript">var disqus_shortname="your-disqus-ID",disqus_identifier="http://www.pinghuazhuang.com/2017/03/06/jQuery-code/jQuery-整体架构/",disqus_url="http://www.pinghuazhuang.com/2017/03/06/jQuery-code/jQuery-整体架构/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="/old-blog//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){anchors.options={visible:"hover",placement:"left",icon:"ℬ"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style>@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"></ul><p class="copyright text-muted">Copyright &copy; hodo 2015<br>Theme by <a href="http://huangxuan.me">Hux</a> <span style="display:inline-block;margin:0 5px"><i class="fa fa-heart"></i> </span>re-Ported by <a href="http://www.pinghuazhuang.com">hodo</a> |<iframe style="margin-left:2px;margin-bottom:-5px" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=PingHuaZhuang&repo=PingHuaZhuang.github.io&type=star&count=true"></iframe></p></div></div></div></footer><script src="/old-blog/js/jquery.min.js"></script><script src="/old-blog/js/bootstrap.min.js"></script><script src="/old-blog/js/hux-blog.min.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>0!==$("#tag_cloud").length&&async("http://www.pinghuazhuang.com/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script>var _gaId="UA-XXXXXXXX-X",_gaDomain="yoursite";!function(e,a,n,t,o,c,g){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=a.createElement(n),g=a.getElementsByTagName(n)[0],c.async=1,c.src="/old-blog//www.google-analytics.com/analytics.js",g.parentNode.insertBefore(c,g)}(window,document,"script",0,"ga"),ga("create",_gaId,_gaDomain),ga("send","pageview")</script><script type="text/javascript" src="/old-blog/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="/old-blog/js/toc.js?v=1.0.0" async></script><img src="http://www.pinghuazhuang.com/img/icon_wechat.png" width="0" height="0"></body></html>
